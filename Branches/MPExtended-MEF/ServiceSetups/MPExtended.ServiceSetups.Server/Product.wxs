<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:fire="http://schemas.microsoft.com/wix/FirewallExtension"
     xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension">
  <!--
  Copyright (C) 2011 MPExtended Developers, http://mpextended.codeplex.com/
  
  MPExtended is free software: you can redistribute it and/or modify
  it under the terms of the GNU General Public License as published by
  the Free Software Foundation, either version 2 of the License, or
  (at your option) any later version.
  
  MPExtended is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  GNU General Public License for more details.
  
  You should have received a copy of the GNU General Public License
  along with MPExtended. If not, see <http://www.gnu.org/licenses/>.
  -->
  <Product
    Id="5c6ca306-2749-4445-a999-f4fb710d824b"
    UpgradeCode="b2aba63e-2197-4c28-b114-c4b0c49efc7c"
    Name="MPExtended Server Services"
    Language="1033"
    Version="!(bind.FileVersion.MPExtended.Services.StreamingService.dll)"
    Manufacturer="MPExtended">

    <?include ../MPExtended.ServiceSetups.General/MPExtended.wxi ?>

    <!-- Directory structure-->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="MPExtendedDir" Name="MPExtended">
          <Directory Id="InstallDirectory" Name="SingleSeat Service">
            <?include ../MPExtended.ServiceSetups.General/StreamBinaries.wxi ?>

            <Component Id="Component_MPExtended" Guid="8dba1ffb-242c-4517-a3f6-f5c43b845b99">
              <File Source="$(var.MPExtended.ServiceHosts.Server.TargetDir)\MPExtended.ServiceHosts.Server.exe" KeyPath="yes" Id="MainService" />
              <File Source="$(var.MPExtended.ServiceHosts.Server.TargetDir)\MPExtended.ServiceHosts.Server.exe.config" />
              <File Source="$(var.MPExtended.ServiceHosts.Server.TargetDir)\NLog.config" />

              <?include ../MPExtended.ServiceSetups.General/StreamingService.wxi ?>
              <?include ../MPExtended.ServiceSetups.General/ServerSetup.wxi ?>

              <!-- Service -->
              <ServiceInstall
                Id="InstallService"
                Type="ownProcess"
                Vital="yes"
                Name="MPExtended Server Service"
                DisplayName="MPExtended Server Service"
                Description="Offers remote access to MediaPortal TV Server"
                Start="auto"
                ErrorControl="ignore"
                Interactive="no"
                Account="LocalSystem">
              </ServiceInstall>
              <ServiceControl Id="StartService" Start="install" Stop="both" Remove="uninstall" Name="MPExtended Server Service" Wait="yes" />

              <!-- Add firewall exception -->
              <fire:FirewallException IgnoreFailure="yes" Id="FirewallException" Name="MPExtended Server Service" Scope="localSubnet" Protocol="tcp" Program="[#MainService]"/>
            </Component>
          </Directory>
        </Directory>
      </Directory>

      <Directory Id="CommonAppDataFolder">
        <Directory Id="OurAppDataFolder" Name="MPExtended">
          <Component Id="Component_AppData" Guid="6a3f3fb7-81d4-48db-85cd-96677df6834a">
            <File Source="$(var.MPExtended.ServiceHosts.Server.TargetDir)\Services.xml" />
            <File Source="$(var.MPExtended.ServiceHosts.Server.TargetDir)\Streaming.xml" />
            <File Source="$(var.MPExtended.ServiceHosts.Server.TargetDir)\TVAccess.xml" />
          </Component>
        </Directory>
      </Directory>
    </Directory>

    <Feature Id="ProductFeature" Title="MPExtended.ServiceSetups.Server" Level="1">
      <ComponentRef Id="Component_Streaming_FFMpeg"/>
      <ComponentRef Id="Component_Streaming_Segmenter"/>
      <ComponentRef Id="Component_Streaming_VLC"/>
      <ComponentRef Id="Component_Streaming_VLC_Plugins"/>
      <ComponentRef Id="Component_MPExtended" />
      <ComponentRef Id="Component_AppData" />
    </Feature>
  </Product>
</Wix>